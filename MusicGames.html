<!DOCTYPE html>
<html>

<head>
	<style type="text/css">
		body {
			margin: 0px;
		}

		.placeholderImage {
			width: 300px;
			height: 300px;
		}

		#gameContainer {
			border: 1px dashed black;
		}

		#choiceContainer {
			display: table;
			margin: 0 auto;
			border: 1px dashed blue;
		}

		.choiceRow {
			display: table-row;
			text-align: center;
		}

		.gameChoice {
			padding: 10px;
			display: table-cell;
			text-align: center;
			border: 1px dashed red;
		}

		/*
		.gameChoice div {
			border: 1px dashed red;
		}
		*/
		/*
		#startButton {
			color: #0000FF;
		}

		#gameChoices {
			display: table;
			width: 80%;
			margin-left: 10%;
		}

		.choicesRow {
			border: 1px #000000 solid;
			display: table-row;
		}

		.gameChoice {
			border: 2px #FF0000 dashed;
			display: table-cell;
			width: 32%;
			text-align: center;
		}
		*/

	</style>
</head>

<body>
	<div id="pageContainer">
		<div id="gameContainer">
			<div id="choiceContainer">
				<div class="choiceRow">
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
				</div>
				<div class="choiceRow">
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
				</div>
				<div class="choiceRow">
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
					<span class="gameChoice">
						<div>
							<img class="placeholderImage"/>
							<p>Song title</p>
							<p>Artist name</p>
						</div>
					</span>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">

		// Data -------------------

		var spotifyIds = ['5Yj0cfzPPokzpjUa516jsb', '0bV4WoGRzmYV6y7OojZvqr', '66jBbrVByFETJZ6FfpwxX4', '4nuPrKithHbRJXuA9spwu4', '0D7L4pBEGv8ni1cRfaTdMJ', '6roaUdrIQUlTcujSFLtYKI', '7bdDULyOUqNyWu6XPeAnSO', '5vVuiXoHyRGxJeCaHUpgae', '5LyzPhFwF7MgUY3aQD9TAG', '2dcpVsjiNG2eCE1A0jHzzQ', '5Yq58BC5k14EVUJ63cmg8g', '5VU6nvX3BqkqBmOJ2d9vhW', '4Wr14AISsCuBGdkA6rids4', '0BX0eq3SXW4jeZmQ271CpE', '4MvypG63QYhgFml4PbkycS', '1AhDOtG9vPSOmsWgNW0BEY', '2lBilUJAUX9jCNbbpPRQDD', '0vE1E6ZNJGlCHPe95z5Orl', '1VkjgkPh2joHQFXPxALE4w', '714hERk9U1W8FMYkoC83CO', '3FMaoRyUZ07NQIMlCDAEOi', '7ryYUwyBWKnXY4Ebs7F9Ju', '7paiew5fG14JcbGCCpJ0P5', '69rMjPtfWbelVGHM0TZaAr', '7mSUMlp8ttG8H00RePyZ5J', '4hDDfS0yW4YH0VGsJEjSM8', '4j3nXukQfT5RZTdqgZiKt1', '5VAKsbOWGdBbg1VFlu9W8o', '4bEtg70srLrCqQp3Nm2T5R', '3qVQ4akZVrjKXGE4czz8mI', '7cNq0FTl3GYjLc3g232hdA', '7c52LVpkxq3dzMEkDWiQyw', '0MGO9t2qWvKClhjVtzE8tA', '74DrA5fFoGSy4xgkZarZtP', '6qQrGkO4grQ7wKCxhtX1io', '55pdXiMNJNQxehrjkcwmYL', '65ANSaYbBQK6z8fOl0TWVd', '5phyXUNMfJv76epjasKNDS', '7m3dKsll00vBjZqYgZuP62', '69eoS6bEWWfMac4TL36UiM', '2lYe3AhO4dJhBMsvk9uBkw', '3I7bYwN9cMsXm5HqEH76Vv', '4IYoyOVK9oQyJS1QZt5Vyj', '0KMGxYKeUzK9wc5DZCt3HT', '20MxJN12WEqU5eWsuCrwM5', '65uzzraBcb1BE3BiYEztd7', '07KHJvlYBeQVqrmifTEqEp', '7IoKA8yRibsK8Ryy4SH2NL', '2kOOxUIHZvz4TsYE6kHYjb', '3AdX0KdVoMBqe82b19rWAU', '7tV4IBfyJN1E9rC9lxkl2Z', '6BJTagJUFeUxHpVWxTmatw', '58tKMD5v0R4H6ZtgHNyGbO', '5lSvRiMiLnG5HIpcQH4MAz', '3Hp66WUQ6yu69jMrirhSRs', '6J9paEX8rcBYuAIawdnzUj', '3VXoFBJ67ceuFqFdXd6vld', '0qbVccbQLEMbfJcI5wNLTJ', '0FF6HAfbuaVpZC8td4WcmN', '5eze4FmXWb2LvtuMRGcOXq', '2skIFujR9zTTAEXj8tfrw0', '05zCw24BdvZKGeC5NXowVe', '4UN5z3IkTamNxngTsS3Qrm', '763jJ8T1utfvNqz1WRDzx4', '2JOQYyJH6lG8hxpzmInRX0', '5TWPfkeN07aERO0Yn2D2t2', '77PCWchIQ9Dopdp5sahDEc', '67J6NR2Tdl0h2epWHcCBBN', '5dFoWIiJ2814hRwMYDcFiU', '32UDt5O32Ju7gTQWI3Pb7c', '5YtxOL4iUchhynLL9nEBwQ', '4MYb7NWLwXNDB7bYs3HeX8', '29VPObDt1Sg0YBwv8x8aHE', '4QEbXYWpDDWHzXNINdZlzW', '7odZlvyjhlFESLeu2PSZ5z', '2CsghsYEVWEgACHtecmCCj', '3MFa9idQuY4iJLWsZl3tIQ', '7utoClKnLShFg6u6dZ20gp', '3OALvGFqkjzwylB345KOVt', '3KGM2fm1K3p5alOyHGzTyY', '5XEsQ97NshBJ02yXpFSkTa', '1dCZvxf24rGMQNOamU9yy2', '3WOmG6u7bxrcFXwfiKMk80', '093Yob0qYlv7p4KdOXbkB4', '6fobsZ84ye4LF4m9IhsJH4', '4xsjEa8mfniPVJ58lKFP8e', '0WeJT7rCshvzK5BOBiAjBn'];


		// Classes -------------------

		// Functions -------------------

		function replaceSpaces(string) {
			// returns the supplied string with all spaces replaced by %20
			// so it can be used in the spotify search call

			if (string.indexOf(' ') > -1) {
				return replaceSpaces(string.replace(' ', '%20'));
			}

			else {
				return string;
			}
		}

		function getSpotifySearchUrl(artist, trackName, searchType) {
			// creates an appropriate url to call the search api.
			//
			// a quick test showed searching for both artist and track
			// made it harder to match the specific song so this makes
			// a track name search

			var baseSearchUrl = "https://api.spotify.com/v1/search?q=";

			var searchableArtist = replaceSpaces(artist);
			var searchableTrack = replaceSpaces(trackName);

			var artistQuery = "artist:" + searchableArtist;
			var trackQuery = "track:" + searchableTrack;
			var typeQuery = "type=" + searchType;

			//var constructed_query = artistQuery + "&" + trackQuery + "&" + typeQuery;
			var constructed_query = trackQuery + "&" + typeQuery;
			var searchUrl = baseSearchUrl + constructed_query;

			return searchUrl;
		}

		function getSpotifySearchResults(constructedUrl) {
			// call the spotify search api with the supplied url
			// returns a JSON formatted object of the search results

			var searchRequest = new XMLHttpRequest();

			searchRequest.open("GET", constructedUrl, false);
			searchRequest.send(null);

			return JSON.parse(searchRequest.responseText);
		}

		function getSongMatchFromResults(artist, trackName, spotifyTracks) {
			// compares an artist and track to an array of spotify tracks taken
			// from the spotify search results, returns an exact track and artist
			// match immediately, otherwise returns a track match, or null

			var bestTrackResult = null;

			for (var i = 0; i < spotifyTracks.length; i++) {
				var trackNameResult = spotifyTracks[i].name;
				var artistsResult = spotifyTracks[i].artists;

				if (trackName.toLowerCase() == trackNameResult.toLowerCase()) {
					if (bestTrackResult === null) {
						bestTrackResult = spotifyTracks[i];
					}

					for (var j = 0; j < artistsResult.length; j++) {
						var artistName = artistsResult[j].name;

						if (artist.toLowerCase() == artistName.toLowerCase()) {
							return spotifyTracks[i];
						}
					}
				}
			}

			//console.log('Returning best result for:', artist, trackName, bestTrackResult);
			return bestTrackResult;
		}

		function getTrackBySpotifyId(spotifyId) {
			var getTrackUrlBase = 'https://api.spotify.com/v1/tracks/' // +{id}
			var fullUrl = getTrackUrlBase + spotifyId;

			var trackRequest = new XMLHttpRequest();
			trackRequest.open("GET", fullUrl, false);
			trackRequest.send(null);

			return JSON.parse(trackRequest.responseText);
		}

		function getArtUrlsFromSongSet(songSet) {
			artSet = [];

			for (var i = 0; i < songSet.length; i++) {
				artSet.push(songSet[i].album.images[1].url);
			}

			return artSet;
		}

		function createImageFromUrl(imageUrl) {
			var img = new Image();
			img.src = imageUrl;

			return img;
		}

		// UI Handling

		UserInterface = function() {

		};

		// Game Handling

		GameData = function() {
			this.songSet = null; // an array of spotify track objects
			this.idSet = spotifyIds;

			this.optionCount = 9;
			this.songOptions = null;

			this.removeSongFromSet = function(trackObject) {
				if (this.songSet === null) {
					alert("No set to remove song from!");
					return;
				}

				var songIndex = this.songSet.indexOf(trackObject);

				if (songIndex == -1) {
					alert("Song not found in set");
					return;
				}

				var removedSong = this.songSet.splice(songIndex, 1);
			};

			this.setSongOptions = function() {
				if (this.songOptions === null) {
					this.songOptions = [];
				}

				if (this.songSet != null && this.songSet.length > this.optionCount) {
					// if spotify data was preloaded
					for (var i = 0; i < this.optionCount; i++) {
						var randIndex = Math.floor(Math.random() * this.songSet.length);
						var randomSong = this.songSet[randIndex];

						while (this.songOptions.indexOf(randomSong) != -1) {
							var newRandIndex = Math.floor(Math.random() * this.songSet.length);
							randomSong = this.songSet[newRandIndex];
						}

						this.songOptions.push(randomSong);
					}

					return;
				}

				if (this.songSet === null && this.idSet != null &&
					this.idSet.length > this.optionCount) {
					// for lazy loading

					var chosenIds = [];

					for (var i = 0; i < this.optionCount; i++) {
						var randIndex = Math.floor(Math.random() * this.idSet.length);
						var randomId = this.idSet[randIndex];

						while (chosenIds.indexOf(randomId) != -1) {
							var newRandIndex = Math.floor(Math.random() * this.idSet.length);
							randomId = this.idSet[newRandIndex];
						}

						chosenIds.push(randomId);

						var randomSong = getTrackBySpotifyId(randomId);

						this.songSet.push(randomSong);
						this.songOptions.push(randomSong);
					}

					return;
				}

				alert("Couldn't load song choices!");
			};
		};

		Game = function() {
			this.initialize = function() {
				this.data = new GameData();
				this.ui = new UserInterface();

				/*if (this.data.songSet === null) {
					this.data.songSet = [];

					var songIds = spotifyIds;

					for (var i = 0; i < songIds.length; i++) {
						this.data.songSet.push(getTrackBySpotifyId(songIds[i]));
					}
				}*/
			};

			this.startGame = function() {
				this.data.setSongOptions();

				var chosenSongIndex = Math.floor(Math.random() * this.data.songOptions.length);
				var artUrls = getArtUrlsFromSongSet(this.data.songOptions);
				console.log(this.data.songOptions[chosenSongIndex]);
				console.log(artUrls);
			};

			/*
			this.data = new GameData();

			this.initialize = function() {
				this.setSongList(chartFrom1981);
				this.data.songChoices = this.selectRandomSongs(this.data.songChoiceCount);

				this.ui = new UserInterface();
				this.ui.initialize();

				var startButton = document.getElementById("startButton");
				var playButton = document.getElementById("playSong");

				this.addEventListeners(startButton, "click");
				this.addEventListeners(playButton, "click");
			};

			this.setSongList = function(songData) {
				var songs = [];

				for (var i = 0; i < songData.length; i++) {
					songs.push(new Song(songData[i].artist, songData[i].title));

					songs[songs.length - 1].year = 1981;
					songs[songs.length - 1].yearRank = songData[i].rank;

					if (songData.length < 10) {
						songs[songs.length - 1].setSpotifyData();
					}
				}

				this.data.songs = songs;
			};

			this.addEventListeners = function(element, listenerType) {
				element.addEventListener(listenerType, this, false);
			};

			this.handleEvent = function(e) {
				var eventType = e.type;
				var eventElement = e.srcElement;

				console.log(eventElement);

				if (eventElement.id == 'startButton') {
					this.beginGame();
				}

				else if (eventElement.id == 'playSong') {
					this.playSongPreview();
				}

				else if (eventElement.className == 'albumArt') {
					console.log(this.checkForSongMatch(e.toElement));
					//console.log('clicked game choice', e.toElement.parentElement);
				}
			};

			this.beginGame = function() {
				this.ui.removeWelcome();
				this.ui.showGame();

				var correctSongIndex = Math.floor(Math.random() * this.data.songChoiceCount);
				console.log(this.data.songChoices[correctSongIndex]);

				this.data.audioPreview = new Audio();
				this.data.audioPreview.src = this.data.songChoices[correctSongIndex].spotifyData.preview_url;

				var choiceContainers = document.getElementsByClassName("gameChoice");

				this.ui.addChoicesArt(this.data.songChoices, choiceContainers);

				for (var i = 0; i < choiceContainers.length; i++) {
					var choiceArt = choiceContainers[i].childNodes[0];

					if (choiceArt.className == "albumArt") {
						this.addEventListeners(choiceArt, "click");
					}

					else {
						console.log("Couldn't add art event listener...");
					}
				}
			};

			this.playSongPreview = function() {
				if (this.data.audioPreview.paused) {
					this.data.audioPreview.play();
				}
				else {
					this.data.audioPreview.pause();
				}
			};

			this.selectRandomSongs = function(songCount) {
				// attempts to remove n songs from this.data.songs and returns
				// them as a new array with song.spotifyData info added
				// returns null if there aren't enough available songs to choose from
				// n = songCount
				// ** fix this to not alter this.data.songs **

				var randomSongs = [];

				for (var i = 0; i < songCount; i++) {
					var songsNeeded = songCount - i;

					if (songsNeeded > this.data.songs.length) {
						for (var j = 0; j < randomSongs.length; j++) {
							this.data.songs.push(randomSongs[j]);
						}

						alert("Couldn't find enough songs to play");
						return null;
					}

					var randIndex = Math.floor(Math.random() * this.data.songs.length);
					var randomSong = this.data.songs.splice(randIndex, 1)[0];

					if (randomSong.spotifyData === null) {
						randomSong.setSpotifyData();

						if (randomSong.spotifyData != null) {
							randomSongs.push(randomSong);
						}

						else {
							songCount++;
						}
					}

					else {
						randomSongs.push(randomSong);
					}
				}

				return randomSongs;
			};

			this.checkForSongMatch = function(clickedElement) {
				// clickedElement should be the album art image element
				// this checks for a match by determining the correct song from
				// the preview url, then compares the available album art urls
				// to the clicked art url. this makes it a little harder to cheat
				// than having the correct song stored in this.data

				var correctSong = null;

				for (var i = 0; i < this.data.songChoices.length; i++) {
					var previewUrl = this.data.songChoices[i].spotifyData.preview_url;

					if (previewUrl == this.data.audioPreview.src) {
						correctSong = this.data.songChoices[i];

						break;
					}
				}

				if (correctSong != null) {
					var correctSongArt = correctSong.spotifyData.album.images;

					for (var i = 0; i < correctSongArt.length; i++) {
						if (correctSongArt[i].url == clickedElement.src) {
							return true;
						}
					}

					return false;
				}

				console.log("Couldn't determine song match");
				return null;
			};
			*/
		};

		// Testing -------------------

		var game = new Game();
		game.initialize();
		game.startGame();

		var choiceSpans = document.getElementsByClassName("gameChoice");
		var placeholderImages = document.getElementsByClassName("placeholderImage");
		var choiceRows = document.getElementsByClassName("choiceRow");
		var choiceContainer = document.getElementById("choiceContainer");
		//game.beginGame();


	</script>
</body>

</html>
