<!DOCTYPE html>
<html>

<head>
	<style type="text/css">
		#startButton {
			color: #0000FF;
		}

	</style>
</head>

<body>
	<div id="pageContainer">
		<div id="welcomeContainer">
			<h1>Hi</h1>
			<button id="startButton">Get started!</button>
		</div>
	</div>

	<script type="text/javascript">

		// Data -------------------

		var chartFrom1981 = [
			{"rank": 1, "artist": "Kim Carnes", "title": "Bette Davis Eyes"},
			{"rank": 2, "artist": "Diana Ross & Lionel Richie", "title": "Endless Love"},
			{"rank": 3, "artist": "Kenny Rogers", "title": "Lady"},
			{"rank": 4, "artist": "John Lennon", "title": "(Just Like) Starting Over"},
			{"rank": 5, "artist": "Rick Springfield", "title": "Jessie's Girl"},
			{"rank": 6, "artist": "Kool & the Gang", "title": "Celebration"},
			{"rank": 7, "artist": "Hall & Oates", "title": "Kiss on My List"},
			{"rank": 8, "artist": "Eddie Rabbitt", "title": "I Love a Rainy Night"},
			{"rank": 9, "artist": "Dolly Parton", "title": "9 to 5"},
			{"rank": 10, "artist": "REO Speedwagon", "title": "Keep on Loving You"},
			{"rank": 11, "artist": "Joey Scarbury", "title": "Theme from The Greatest American Hero (Believe It or Not)"},
			{"rank": 12, "artist": "Sheena Easton", "title": "Morning Train (Nine to Five)"},
			{"rank": 13, "artist": "Smokey Robinson", "title": "Being with You"},
			{"rank": 14, "artist": "Juice Newton", "title": "Queen of Hearts"},
			{"rank": 15, "artist": "Blondie", "title": "Rapture"},
			{"rank": 16, "artist": "Raydio", "title": "A Woman Needs Love (Just Like You Do)"},
			{"rank": 17, "artist": "Blondie", "title": "The Tide Is High"},
			{"rank": 18, "artist": "Grover Washington, Jr. & Bill Withers", "title": "Just the Two of Us"},
			{"rank": 19, "artist": "The Pointer Sisters", "title": "Slow Hand"},
			{"rank": 20, "artist": "Climax Blues Band", "title": "I Love You"},
			{"rank": 21, "artist": "John Lennon", "title": "Woman"},
			{"rank": 22, "artist": "A Taste of Honey", "title": "Sukiyaki"},
			{"rank": 23, "artist": "ABBA", "title": "The Winner Takes It All"},
			{"rank": 24, "artist": "Stars on 45", "title": "Stars on 45 Medley"},
			{"rank": 25, "artist": "Juice Newton", "title": "Angel of the Morning"},
			{"rank": 26, "artist": "Neil Diamond", "title": "Love on the Rocks"},
			{"rank": 27, "artist": "Air Supply", "title": "Every Woman in the World"},
			{"rank": 28, "artist": "Air Supply", "title": "The One That You Love"},
			{"rank": 29, "artist": "Barbra Streisand & Barry Gibb", "title": "Guilty"},
			{"rank": 30, "artist": "Styx", "title": "The Best of Times"},
			{"rank": 31, "artist": "The Oak Ridge Boys", "title": "Elvira"},
			{"rank": 32, "artist": "REO Speedwagon", "title": "Take It on the Run"},
			{"rank": 33, "artist": "Ronnie Milsap", "title": "(There's) No Gettin' Over Me"},
			{"rank": 34, "artist": "Gino Vannelli", "title": "Living Inside Myself"},
			{"rank": 35, "artist": "Barbra Streisand", "title": "Woman in Love"},
			{"rank": 36, "artist": "The Manhattan Transfer", "title": "The Boy from New York City"},
			{"rank": 37, "artist": "Foreigner", "title": "Urgent"},
			{"rank": 38, "artist": "Rod Stewart", "title": "Passion"},
			{"rank": 39, "artist": "Commodores", "title": "Lady (You Bring Me Up)"},
			{"rank": 40, "artist": "Don McLean", "title": "Crying"},
			{"rank": 41, "artist": "Marty Balin", "title": "Hearts"},
			{"rank": 42, "artist": "Diana Ross", "title": "It's My Turn"},
			{"rank": 43, "artist": "Hall & Oates", "title": "You Make My Dreams"},
			{"rank": 44, "artist": "Kenny Rogers", "title": "I Don't Need You"},
			{"rank": 45, "artist": "Champaign", "title": "How 'Bout Us"},
			{"rank": 46, "artist": "Pat Benatar", "title": "Hit Me with Your Best Shot"},
			{"rank": 47, "artist": "The Greg Kihn Band", "title": "The Breakup Song (They Don't Write 'Em)"},
			{"rank": 48, "artist": "The Alan Parsons Project", "title": "Time"},
			{"rank": 49, "artist": "Bruce Springsteen", "title": "Hungry Heart"},
			{"rank": 50, "artist": "Franke and the Knockouts", "title": "Sweetheart"},
			{"rank": 51, "artist": "Terri Gibbs", "title": "Somebody's Knockin'"},
			{"rank": 52, "artist": "Leo Sayer", "title": "More Than I Can Say"},
			{"rank": 53, "artist": "Tierra", "title": "Together"},
			{"rank": 54, "artist": "Styx", "title": "Too Much Time on My Hands"},
			{"rank": 55, "artist": "Dottie West & Kenny Rogers", "title": "What Are We Doin' in Love"},
			{"rank": 56, "artist": "Journey", "title": "Who's Crying Now"},
			{"rank": 57, "artist": "The Police", "title": "De Do Do Do, De Da Da Da"},
			{"rank": 58, "artist": "Gary U.S. Bonds", "title": "This Little Girl"},
			{"rank": 59, "artist": "Stevie Nicks & Tom Petty", "title": "Stop Draggin' My Heart Around"},
			{"rank": 60, "artist": "Delbert McClinton", "title": "Giving It Up for Your Love"},
			{"rank": 61, "artist": "Cliff Richard", "title": "A Little in Love"},
			{"rank": 62, "artist": "Neil Diamond", "title": "America"},
			{"rank": 63, "artist": "John Cougar", "title": "Ain't Even Done With The Night"},
			{"rank": 64, "artist": "Christopher Cross", "title": "Arthur's Theme (Best That You Can Do)"},
			{"rank": 65, "artist": "Queen", "title": "Another One Bites the Dust"},
			{"rank": 66, "artist": "The Alan Parsons Project", "title": "Games People Play"},
			{"rank": 67, "artist": "Eric Clapton", "title": "I Can't Stand It"},
			{"rank": 68, "artist": "Steve Winwood", "title": "While You See a Chance"},
			{"rank": 69, "artist": "Stevie Wonder", "title": "Master Blaster (Jammin')"},
			{"rank": 70, "artist": "Neil Diamond", "title": "Hello Again"},
			{"rank": 71, "artist": "The Police", "title": "Don't Stand So Close to Me"},
			{"rank": 72, "artist": "Steely Dan", "title": "Hey Nineteen"},
			{"rank": 73, "artist": "Stevie Wonder", "title": "I Ain't Gonna Stand for It"},
			{"rank": 74, "artist": "George Harrison", "title": "All Those Years Ago"},
			{"rank": 75, "artist": "Eddie Rabbitt", "title": "Step By Step"},
			{"rank": 76, "artist": "Billy Squier", "title": "The Stroke"},
			{"rank": 77, "artist": "Alabama", "title": "Feels So Right"},
			{"rank": 78, "artist": "George Duke & Stanley Clarke", "title": "Sweet Baby"},
			{"rank": 79, "artist": "Dan Fogelberg", "title": "Same Old Lang Syne"},
			{"rank": 80, "artist": "Pablo Cruise", "title": "Cool Love"},
			{"rank": 81, "artist": "Electric Light Orchestra", "title": "Hold on Tight"},
			{"rank": 82, "artist": "John Schneider", "title": "It's Now or Never"},
			{"rank": 83, "artist": "Pat Benatar", "title": "Treat Me Right"},
			{"rank": 84, "artist": "Santana", "title": "Winning"},
			{"rank": 85, "artist": "Barbra Streisand & Barry Gibb", "title": "What Kind of Fool"},
			{"rank": 86, "artist": "John Lennon", "title": "Watching the Wheels"},
			{"rank": 87, "artist": "Heart", "title": "Tell It Like It Is"},
			{"rank": 88, "artist": "Ronnie Milsap", "title": "Smoky Mountain Rain"},
			{"rank": 89, "artist": "Barry Manilow", "title": "I Made It Through the Rain"},
			{"rank": 90, "artist": "Hall & Oates", "title": "You've Lost That Lovin' Feelin'"},
			{"rank": 91, "artist": "Olivia Newton-John & Cliff Richard", "title": "Suddenly"},
			{"rank": 92, "artist": "Sheena Easton", "title": "For Your Eyes Only"},
			{"rank": 93, "artist": "The Beach Boys", "title": "The Beach Boys Medley"},
			{"rank": 94, "artist": "Devo", "title": "Whip It"},
			{"rank": 95, "artist": "Sheena Easton", "title": "Modern Girl"},
			{"rank": 96, "artist": "Gary Wright", "title": "Really Wanna Know You"},
			{"rank": 97, "artist": "Rosanne Cash", "title": "Seven Year Ache"},
			{"rank": 98, "artist": "Diana Ross", "title": "I'm Coming Out"},
			{"rank": 99, "artist": "Boz Scaggs", "title": "Miss Sun"},
			{"rank": 100, "artist": "Andy Gibb", "title": "Time Is Time"}
		];

		// Classes -------------------

		Song = function(artist, trackName) {
			this.artist = artist;
			this.trackName = trackName;

			this.year = null;
			this.yearRank = null;

			this.spotifyData = null;

			this.setSpotifyData = function() {
				// attempts to set this.spotifyData to a spotify track object by
				// searching spotify for the track name and checking the results
				// for a case-insensitive exact track name match (prefers an
				// exact artist match)

				if (this.spotifyData != null) {
					return;
				}

				// request spotify search results
				var searchUrl = getSpotifySearchUrl(this.artist, this.trackName, 'track');
				var searchResults = getSpotifySearchResults(searchUrl);// + "&limit=5");
				//console.log(searchResults);

				// match artist/track to results
				var tracks = searchResults.tracks.items;
				var matchedSong = getSongMatchFromResults(this.artist, this.trackName, tracks);

				// set this.spotifyData to track result
				if (matchedSong != null) {
					//console.log('Successfully matched:', this.artist, this.trackName);
					this.spotifyData = matchedSong;
				}

				else {
					//console.log("Couldn't get spotify data for:", this.artist, this.trackName);
				}
			};
		};

		// Functions -------------------

		function replaceSpaces(string) {
			// returns the supplied string with all spaces replaced by %20
			// so it can be used in the spotify search call

			if (string.indexOf(' ') > -1) {
				return replaceSpaces(string.replace(' ', '%20'));
			}

			else {
				return string;
			}
		}

		function getSpotifySearchUrl(artist, trackName, searchType) {
			// creates an appropriate url to call the search api.
			//
			// a quick test showed searching for both artist and track
			// made it harder to match the specific song so this makes
			// a track name search

			var baseSearchUrl = "https://api.spotify.com/v1/search?q=";

			var searchableArtist = replaceSpaces(artist);
			var searchableTrack = replaceSpaces(trackName);

			var artistQuery = "artist:" + searchableArtist;
			var trackQuery = "track:" + searchableTrack;
			var typeQuery = "type=" + searchType;

			//var constructed_query = artistQuery + "&" + trackQuery + "&" + typeQuery;
			var constructed_query = trackQuery + "&" + typeQuery;
			var searchUrl = baseSearchUrl + constructed_query;

			return searchUrl;
		}

		function getSpotifySearchResults(constructedUrl) {
			// call the spotify search api with the supplied url
			// returns a JSON formatted object of the search results

			var searchRequest = new XMLHttpRequest();

			searchRequest.open("GET", constructedUrl, false);
			searchRequest.send(null);

			return JSON.parse(searchRequest.responseText);
		}

		function getSongMatchFromResults(artist, trackName, spotifyTracks) {
			// compares an artist and track to an array of spotify tracks taken
			// from the spotify search results, returns an exact track and artist
			// match immediately, otherwise returns a track match, or null

			var bestTrackResult = null;

			for (var i = 0; i < spotifyTracks.length; i++) {
				var trackNameResult = spotifyTracks[i].name;
				var artistsResult = spotifyTracks[i].artists;

				if (trackName.toLowerCase() == trackNameResult.toLowerCase()) {
					bestTrackResult = spotifyTracks[i];

					for (var j = 0; j < artistsResult.length; j++) {
						var artistName = artistsResult[j].name;

						if (artist.toLowerCase() == artistName.toLowerCase()) {
							return spotifyTracks[i];
						}
					}
				}
			}

			//console.log('Returning best result for:', artist, trackName, bestTrackResult);

			return bestTrackResult;
		}

		// UI Handling

		UserInterface = function() {
			this.removeWelcome = function() {
				var welcomeContainer = document.getElementById("welcomeContainer");
				welcomeContainer.remove();
			};
		};

		// Game Handling

		Game = function() {
			this.songs = null;

			this.initialize = function() {
				this.setSongList(chartFrom1981);

				this.ui = new UserInterface();

				//for (var songIndex = 0; songIndex < songs.length; songIndex++) {
				//	songs[songIndex].setSpotifyData();
				//}

				this.addEventListeners("startButton", "click");
			};

			this.setSongList = function(songData) {
				this.songs = [];

				for (var i = 0; i < songData.length; i++) {
					this.songs.push(new Song(songData[i].artist, songData[i].title));

					this.songs[this.songs.length - 1].year = 1981;
					this.songs[this.songs.length - 1].yearRank = songData[i].rank;

					if (songData.length < 10) {
						this.songs[this.songs.length - 1].setSpotifyData();
					}
				}
			};

			this.addEventListeners = function(elementId, listenerType) {
				var element = document.getElementById(elementId);
				element.addEventListener(listenerType, this, false);
			};

			this.handleEvent = function(e) {
				var eventType = e.type;
				var eventElement = e.srcElement;

				if (eventElement.id == 'startButton') {
					this.beginGame();
				}
			};

			this.beginGame = function() {
				this.ui.removeWelcome();

				var randomSongs = this.selectRandomSongs(9);

				//console.log(this.songs.length);
				console.log(randomSongs);
			};

			this.selectRandomSongs = function(songCount) {
				// attempts to remove songCount songs from this.songs and return
				// them as a new array. returns null if there are enough songs
				// available in this.songs

				var randomSongs = [];

				for (var i = 0; i < songCount; i++) {
					var songsNeeded = songCount - i;

					if (songsNeeded > this.songs.length) {
						for (var j = 0; j < randomSongs.length; j++) {
							this.songs.push(randomSongs[j]);
						}

						alert("Couldn't find enough songs to play");
						return null;
					}

					var randIndex = Math.floor(Math.random() * this.songs.length);
					var randomSong = this.songs.splice(randIndex, 1)[0];

					if (randomSong.spotifyData === null) {
						randomSong.setSpotifyData();

						if (randomSong.spotifyData != null) {
							randomSongs.push(randomSong);
						}

						else {
							songCount++;
						}
					}

					else {
						randomSongs.push(randomSong);
					}
				}

				return randomSongs;
			};
		};

		// Testing -------------------

		var game = new Game();
		game.initialize();

		var pageContainer = document.getElementById("pageContainer");

		/*
		for (var songIndex = 0; songIndex < 15; songIndex++) {
			songs[songIndex].setSpotifyData();

			if (songs[songIndex].spotifyData != null) {
				var newSongContainer = document.createElement("div");
				pageContainer.appendChild(newSongContainer);

				var albumArt = document.createElement("img");
				albumArt.src = songs[songIndex].spotifyData.album.images[0].url;

				newSongContainer.appendChild(albumArt);
			}
		}*/

	</script>
</body>

</html>
